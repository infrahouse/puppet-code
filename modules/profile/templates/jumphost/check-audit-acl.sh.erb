#!/bin/bash
# Managed by Puppet
# Verify CloudWatch agent can read audit logs via ACLs

AUDIT_LOG_FILE="<%= @audit_log_file %>"

# Check if ACL exists on the log file
if ! /usr/bin/getfacl "${AUDIT_LOG_FILE}" 2>/dev/null | /usr/bin/grep -q "user:cwagent:r-x"; then
    echo "ACL not set on ${AUDIT_LOG_FILE}"
    exit 1
fi

# Test if cwagent user can actually read the file
if ! sudo -u cwagent test -r "${AUDIT_LOG_FILE}"; then
    echo "cwagent cannot read ${AUDIT_LOG_FILE} despite ACL"
    exit 1
fi

echo "ACLs verified: cwagent can read ${AUDIT_LOG_FILE}"
exit 0
